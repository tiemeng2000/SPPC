(function($){$.LeapG={};$.LeapG.Controller=function(){this.leapController=null;this.pointers=[];this._initialize=function(){var controller=!this.leapController;if(controller){this.leapController=new Leap.Controller({enableGestures:true})}this._bindFrameListener();if(controller){$("body").focus();this.leapController.connect()}};this._bindFrameListener=function(){this.leapController.on("connect",this.onConnect.bind(this));this.leapController.on("frame",this.onFrame.bind(this));this.leapController.on("gesture",this.onGesture.bind(this))};this.onConnect=function(){console.log("LeapMotion Device Connect Succeed!")};this.onFrame=function(frame){var pointers=this.pointers;var pointer=null;while(pointers.length>frame.hands.length){pointers.pop().removePointer()}frame.hands.forEach(function(hand,index){pointer=(pointers[index]||(pointers[index]=new $.LeapG.Pointer()));pointer.bindPointerToHand(index,hand.id);var framePos=$.LeapG.leapToScene(hand,frame);if(framePos===null){console.log("framePos为空");return}pointer.updatePosition(framePos);pointer.handEventTrigger(hand)})};this.onGesture=function(gesture,hand){var duration=gesture.duration;var pointableIds=gesture.pointableIds;var type=gesture.type;var handId=gesture.handIds[0];var state=gesture.state;var id=gesture.id;var pointers=this.pointers;var pointer=null;for(var index in pointers){if(pointers[index].handId===handId){pointer=pointers[index]}}if(type==="circle"){if(parseInt(pointableIds)===hand.pointables[1].id){if(state==="start"){pointer.cursor.trigger("HAND_CIRCLE_START")}else{if(state==="stop"){pointer.cursor.trigger("HAND_CIRCLE_END")}}}}else{if(type==="swipe"&&!pointer.is_hand_pinching&&!pointer.is_hand_pointing){if((state==="start")&&!pointer.is_hand_swiping){pointer.is_hand_swiping=true;pointer.cursor.trigger("HAND_SWIPE_START")}else{if((state==="stop")&&pointer.is_hand_swiping){pointer.is_hand_swiping=false;pointer.cursor.trigger("HAND_SWIPE_END")}}}else{if(type==="keyTap"&&!pointer.is_hand_swiping&&!pointer.is_hand_pinching&&!pointer.is_hand_pointing){if(parseInt(pointableIds)===hand.pointables[1].id||parseInt(pointableIds)===hand.pointables[2].id||parseInt(pointableIds)===hand.pointables[3].id||parseInt(pointableIds)===hand.pointables[4].id){pointer.cursor.trigger("HAND_TAP_START");pointer.cursor.delay(300).queue(function(){pointer.cursor.trigger("HAND_TAP_END");pointer.cursor.clearQueue()})}}else{if(type==="screenTap"){pointer.cursor.trigger("HAND_SCREENTAP")}}}}};this._initialize()};$.LeapG.Pointer=function(){this.cursor=null;this.tips=$("<span> </span>");this.currX=null;this.currY=null;this.prevX=null;this.prevY=null;this.index=null;this.handId=null;this.currPos=[this.currX,this.currY];this.prevPos=[this.prevX,this.prevY];this.is_hand_pinching=false;this.is_hand_swiping=false;this.is_hand_pointing=false;this._init=function(){var no_cursor=!this.cursor;if(no_cursor){this._createCursor()}this._bindPointerEvent();if(true){this.addPointer()}};this._createCursor=function(){this.cursor=$("<span></span>");this.cursor.css({"display":"block","background-image":"url(../leapjs-MouseHands/css/cursor_0.1_rhand.png)","background-repeat":"no-repeat","background-size":"100% 100%","opacity":"1","margin":"0px","padding":"0px","width":"32px","height":"32px","position":"absolute","zIndex":"255",})};this.addPointer=function(){this.cursor.appendTo($("body"));this.cursor.trigger("POINTER_ADDED")};this.removePointer=function(){this.cursor.remove();this.cursor.trigger("POINTER_DELETED")};this.updatePosition=function(framePos){this.prevX=this.currX;this.prevY=this.currY;this.currX=framePos[0];this.currY=framePos[1];this.cursor.css({top:this.currY+"px",left:this.currX+"px",});this.cursor.trigger("POINTER_MOVE")};this.bindPointerToHand=function(index,handId){this.index=index;this.handId=handId};this._bindPointerEvent=function(){this.cursor.on("POINTER_ADDED",this.onPointerAdded.bind(this));this.cursor.on("POINTER_DELETED",this.onPointerDeleted.bind(this));this.cursor.on("POINTER_MOVE",this.onPointerMove.bind(this));this.cursor.on("POINTER_ENTER",this.onPointerEnter.bind(this));this.cursor.on("POINTER_LEAVE",this.onPointerLeave.bind(this));this.cursor.on("POINTER_HOVER",this.onPointerHover.bind(this));this.cursor.on("HAND_PINCH",this.onHandPinch.bind(this));this.cursor.on("HAND_UNPINCH",this.onHandUnpinch.bind(this));this.cursor.on("HAND_POINTING",this.onHandPointing.bind(this));this.cursor.on("HAND_UNPOINTING",this.onHandUnpointing.bind(this));this.cursor.on("HAND_SWIPE_START",this.onHandSwipeStart.bind(this));this.cursor.on("HAND_SWIPE_END",this.onHandSwipeEnd.bind(this));this.cursor.on("HAND_TAP_START",this.onHandTapStart.bind(this));this.cursor.on("HAND_TAP_END",this.onHandTapEnd.bind(this));this.cursor.on("HAND_SCREENTAP",this.onHandScreenTap.bind(this));this.cursor.on("HAND_CIRCLE_START",this.onHandCircleStart.bind(this));this.cursor.on("HAND_CIRCLE_END",this.onHandCircleEnd.bind(this))};this.handEventTrigger=function(hand){this.handCheck_Pinch(hand);this.handCheck_Pointing(hand)
};this.handCheck_Pinch=function(hand){var pinchThreshold=0.6;var pinchStrength=hand.pinchStrength;if((pinchStrength>pinchThreshold)&&!this.is_hand_pinching&&!this.is_hand_pointing){this.cursor.trigger("HAND_PINCH");this.is_hand_pinching=true}else{if((pinchStrength<=pinchThreshold)&&this.is_hand_pinching){this.cursor.trigger("HAND_UNPINCH");this.is_hand_pinching=false}}};this.handCheck_Pointing=function(hand){var pointingThreshold=60;var tipDistofPalm=$.LeapG.distanceOfTipsPalm(hand);if((tipDistofPalm<pointingThreshold)&&!this.is_hand_pointing&&!this.is_hand_pinching){this.cursor.trigger("HAND_POINTING");this.is_hand_pointing=true}else{if((tipDistofPalm>=pointingThreshold)&&this.is_hand_pointing){this.cursor.trigger("HAND_UNPOINTING");this.is_hand_pointing=false}}};this.triggerDOMEvent=function(event_name){var evt=document.createEvent("CustomEvent");evt.initCustomEvent(event_name,true,true,null);evt.pageX=(this.currPos===null)?0:this.currX;evt.pageY=(this.currPos===null)?0:this.currY;this.cursor.hide();var element=document.elementFromPoint(evt.pageX,evt.pageY);this.cursor.show();element.dispatchEvent(evt);return element};this.onPointerAdded=function(){return this.triggerDOMEvent("pointeradded")};this.onPointerDeleted=function(){return this.triggerDOMEvent("pointerdeleted")};this.onPointerMove=function(){this.cursor.trigger("POINTER_HOVER");return this.triggerDOMEvent("mousemove")};this.onPointerHover=function(){var currX=(this.currPos===null)?0:this.currX;var currY=(this.currPos===null)?0:this.currY;var prevX=(this.prevPos===null)?0:this.prevX;var prevY=(this.prevPos===null)?0:this.prevY;this.cursor.hide();var eleCurr=document.elementFromPoint(currX,currY);var elePrev=document.elementFromPoint(prevX,prevY);this.cursor.show();if(eleCurr!=elePrev){this.cursor.trigger("POINTER_ENTER");this.cursor.trigger("POINTER_LEAVE")}return eleCurr};this.onPointerEnter=function(){this.triggerDOMEvent("mouseover");return this.triggerDOMEvent("mouseenter")};this.onPointerLeave=function(){var evt=document.createEvent("CustomEvent");var evt2=document.createEvent("CustomEvent");evt2.initCustomEvent("mouseout",true,true,null);evt.initCustomEvent("mouseleave",true,true,null);evt.pageX=(this.prevPos===null)?0:this.prevX;evt.pageY=(this.prevPos===null)?0:this.prevY;this.cursor.hide();var element=document.elementFromPoint(evt.pageX,evt.pageY);this.cursor.show();element.dispatchEvent(evt2);element.dispatchEvent(evt);return element};this.onHandPinch=function(){this.cursor.clearQueue();this.cursor.empty();this.cursor.css({"background-image":"url(../leapjs-MouseHands/css/cursor_0.3_rhand_fist.png)"});this.tips=$("<span>Pinching</span>");this.tips.css({"margin-top":"30px","position":"absolute","color":"#33ccFF"});this.tips.appendTo(this.cursor);this.triggerDOMEvent("mousedown");return this.triggerDOMEvent("handpinch")};this.onHandUnpinch=function(){this.cursor.css({"background-image":"url(../leapjs-MouseHands/css/cursor_0.1_rhand.png)"});this.tips.remove();this.triggerDOMEvent("mouseup");return this.triggerDOMEvent("handunpinch")};this.onHandPointing=function(){this.cursor.css({"background-image":"url(../leapjs-MouseHands/css/cursor_0.3_rhand_pointing.png)"});this.tips=$("<span>Pointing</span>");this.tips.appendTo(this.cursor);this.tips.css({"margin-top":"30px","position":"absolute","color":"#33ccFF"});this.triggerDOMEvent("mousedown");return this.triggerDOMEvent("handpointing")};this.onHandUnpointing=function(){this.cursor.css({"background-image":"url(../leapjs-MouseHands/css/cursor_0.1_rhand.png)"});this.tips.remove();this.triggerDOMEvent("mouseup");return this.triggerDOMEvent("handunpointing")};this.onHandSwipeStart=function(){this.tips=$("<span>Swaping</span>");this.tips.css({"margin-top":"30px","position":"absolute","color":"#33ccFF"});this.tips.appendTo(this.cursor);return this.triggerDOMEvent("handswipestart")};this.onHandSwipeEnd=function(){this.cursor.css({"background-image":"url(../leapjs-MouseHands/css/cursor_0.1_rhand.png)"});this.tips.remove();this.triggerDOMEvent("dblclick");return this.triggerDOMEvent("handswipeend")};this.onHandTapStart=function(){this.triggerDOMEvent("mousedown");this.triggerDOMEvent("mouseup");var tmpCs=this.cursor;tmpCs.empty();var tmpTs=this.tips;tmpTs=$("<span>Tap</span>");tmpTs.css({"margin-top":"30px","position":"absolute","color":"#33ccFF"});tmpCs.animate({height:"48px",width:"48px",opacity:"0.1"},0,"linear");tmpCs.css({"background-image":"url(../leapjs-MouseHands/css/cursor_0.3_rhand_tap.png)"});tmpCs.animate({height:"32px",width:"32px",opacity:"1"},200,"swing");tmpTs.delay(200).queue(function(){tmpTs.appendTo(tmpCs)});return this.triggerDOMEvent("handtapstart")};this.onHandTapEnd=function(){this.cursor.css({"background-image":"url(../leapjs-MouseHands/css/cursor_0.1_rhand.png)"});this.cursor.empty();return this.triggerDOMEvent("handtapend")};this.onHandCircleStart=function(){return this.triggerDOMEvent("handcirclestart")};this.onHandCircleEnd=function(){return this.triggerDOMEvent("handcircleend")
};this.onHandScreenTap=function(){this.triggerDOMEvent("mousedown");this.triggerDOMEvent("mouseup");return this.triggerDOMEvent("handscreentap")};this._init()};$.LeapG.leapToScene=function(hand,frame){var pipThumb=hand.fingers[0].pipPosition;var xThumb=pipThumb[0];var yThumb=pipThumb[1];var zThumb=pipThumb[2];var finger_Index=hand.fingers[1];var xIndex=finger_Index.mcpPosition[0];var yIndex=finger_Index.mcpPosition[1];var zIndex=finger_Index.dipPosition[2];var finger_Ring=hand.fingers[3];var xRing=finger_Ring.carpPosition[0];var yRing=finger_Ring.carpPosition[1];var zRing=finger_Ring.carpPosition[2];var finger_Pinky=hand.fingers[4];var xPinky=finger_Pinky.carpPosition[0];var yPinky=finger_Pinky.carpPosition[1];var zPinky=finger_Pinky.carpPosition[2];var palm=hand.palmPosition;var xPalm=palm[0];var yPalm=palm[1];var zPalm=palm[2];var palmStabilized=hand.stabilizedPalmPosition;var xPalmStabilized=palmStabilized[0];var yPalmStabilized=palmStabilized[1];var zPalmStabilized=palmStabilized[2];var tipx=xPalmStabilized;var tipy=yPalmStabilized;var tipz=zPalm;var tip=[tipx*0.5,tipy,tipz];var ibox=frame.interactionBox;var npos=ibox.normalizePoint(tip);npos[1]=npos[1]-0.2;var w_win=$(window).width();var h_win=$(window).height();var w_doc=$(document).width();var h_doc=$(document).height();var x=w_win*npos[0];var y=h_win*(1-npos[1]);if((x<0)||(x>w_win)||(y<0)||(y>h_win)){return null}return[x,y]};$.LeapG.distanceOfThumbIndex=function(hand){var dI=0;var dM=0;var dI_Leap=0;var dipThumb=hand.fingers[0].dipPosition;var tipThumb=dipThumb;var xThumb=tipThumb[0];var yThumb=tipThumb[1];var zThumb=tipThumb[2];var dipIndex=hand.fingers[1].dipPosition;var tipIndex=dipIndex;var xIndex=tipIndex[0];var yIndex=tipIndex[1];var zIndex=tipIndex[2];var dipMiddle=hand.fingers[2].dipPosition;var tipMiddle=dipMiddle;var xMiddle=tipMiddle[0];var yMiddle=tipMiddle[1];var zMiddle=tipMiddle[2];dI=Math.sqrt(Math.pow((xThumb-xIndex),2)+Math.pow((yThumb-yIndex),2));dM=Math.sqrt(Math.pow((xThumb-xMiddle),2)+Math.pow((yThumb-yMiddle),2));dI_Leap=Leap.vec3.distance(hand.thumb.dipPosition,hand.indexFinger.dipPosition);return dI_Leap};$.LeapG.distanceOfTipsPalm=function(hand){var dI=Leap.vec3.distance(hand.palmPosition,hand.indexFinger.dipPosition);var dM=Leap.vec3.distance(hand.palmPosition,hand.middleFinger.dipPosition);var dR=Leap.vec3.distance(hand.palmPosition,hand.ringFinger.dipPosition);var dP=Leap.vec3.distance(hand.palmPosition,hand.pinky.dipPosition);return dR}})(jQuery);